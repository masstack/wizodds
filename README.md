**Документация по Классу `WizOdds_Prediction_Shortcodes`**
----------------------------------------------------------

### **Содержание**

1.  [Обзор](#1-%D0%BE%D0%B1%D0%B7%D0%BE%D1%80)
2.  [Требования](#2-%D1%82%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F)
3.  [Установка](#3-%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0)
4.  [Описание Шорткодов](#4-%D0%BE%D0%BF%D0%B8%D1%81%D0%B0%D0%BD%D0%B8%D0%B5-%D1%88%D0%BE%D1%80%D1%82%D0%BA%D0%BE%D0%B4%D0%BE%D0%B2)
    -   [1\. custom_prediction](#1-custom_prediction)
    -   [2\. total_stats](#2-total_stats)
    -   [3\. expected_score](#3-expected_score)
    -   [4\. goals_probability](#4-goals_probability)
    -   [5\. both_teams_to_score_probability](#5-both_teams_to_score_probability)
    -   [6\. custom_stat](#6-custom_stat)
    -   [7\. custom_match_shortcode](#7-custom_match_shortcode)
5.  [Описание Основных Функций](#5-%D0%BE%D0%BF%D0%B8%D1%81%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BE%D1%81%D0%BD%D0%BE%D0%B2%D0%BD%D1%8B%D1%85-%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%B9)
    -   [Функции для Получения и Обработки Данных](#%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%B8-%D0%B4%D0%BB%D1%8F-%D0%BF%D0%BE%D0%BB%D1%83%D1%87%D0%B5%D0%BD%D0%B8%D1%8F-%D0%B8-%D0%BE%D0%B1%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B8-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85)
    -   [Функции для Расчета Предсказаний](#%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%B8-%D0%B4%D0%BB%D1%8F-%D1%80%D0%B0%D1%81%D1%87%D0%B5%D1%82%D0%B0-%D0%BF%D1%80%D0%B5%D0%B4%D1%81%D0%BA%D0%B0%D0%B7%D0%B0%D0%BD%D0%B8%D0%B9)
    -   [Функции для Генерации HTML](#%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%B8-%D0%B4%D0%BB%D1%8F-%D0%B3%D0%B5%D0%BD%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%B8-html)
6.  [Примеры Использования](#6-%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D1%8B-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F)
7.  [Расширение и Настройка](#7-%D1%80%D0%B0%D1%81%D1%88%D0%B8%D1%80%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B8-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0)
8.  [Отладка и Логирование](#8-%D0%BE%D1%82%D0%BB%D0%B0%D0%B4%D0%BA%D0%B0-%D0%B8-%D0%BB%D0%BE%D0%B3%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5)
9.  [Безопасность](#9-%D0%B1%D0%B5%D0%B7%D0%BE%D0%BF%D0%B0%D1%81%D0%BD%D0%BE%D1%81%D1%82%D1%8C)
10. [Часто Задаваемые Вопросы (FAQ)](#10-%D1%87%D0%B0%D1%81%D1%82%D0%BE-%D0%B7%D0%B0%D0%B4%D0%B0%D0%B2%D0%B0%D0%B5%D0%BC%D1%8B%D0%B5-%D0%B2%D0%BE%D0%BF%D1%80%D0%BE%D1%81%D1%8B-faq)
11. [Лицензия](#11-%D0%BB%D0%B8%D1%86%D0%B5%D0%BD%D0%B7%D0%B8%D1%8F)

* * * * *

### **1\. Обзор**

Класс `WizOdds_Prediction_Shortcodes` предназначен для интеграции различных шорткодов в WordPress, которые отображают статистику и предсказания результатов футбольных матчей. Он использует данные из плагина **AnWP Football Leagues Premium** для получения информации о матчах, командах и статистике.

### **2\. Требования**

-   **WordPress**: Установленная и настроенная платформа WordPress.
-   **Плагин AnWP Football Leagues Premium**: Необходим для получения данных о матчах, командах и статистике.
-   **PHP**: Версия 7.4 или выше.

### **3\. Установка**

1.  **Создание Файла Плагина:**

    -   Создайте файл PHP, например `wizodds-prediction-shortcodes.php`, в каталоге `wp-content/plugins/`.
2.  **Добавление Кода:**

    -   Скопируйте оптимизированный код (предоставленный ранее) в этот файл.
3.  **Активация Плагина:**

    -   Перейдите в админ-панель WordPress.
    -   Перейдите в раздел **Плагины** → **Добавить новый**.
    -   Найдите ваш плагин и активируйте его.

### **4\. Описание Шорткодов**

#### **1\. `custom_prediction`**

**Описание:** Отображает процентные предсказания для домашней и гостевой команд.

**Атрибуты:**

-   `match_id` *(целое число)*: ID матча, для которого необходимо отобразить предсказание.

**Пример Использования:**

html

Копіювати код

`[custom_prediction match_id="123"]`

**Вывод:** Графическое отображение процентных значений для домашней и гостевой команд.

* * * * *

#### **2\. `total_stats`**

**Описание:** Отображает общую статистику матча, включая среднее количество голов, желтых карточек и угловых.

**Атрибуты:**

-   `home_club_id` *(целое число)*: ID домашней команды.
-   `away_club_id` *(целое число)*: ID гостевой команды.
-   `competition_id` *(целое число)*: ID соревнования.
-   `match_id` *(целое число)*: ID матча.
-   `referee_id` *(целое число)*: ID рефери.

**Пример Использования:**

html

Копіювати код

`[total_stats home_club_id="1" away_club_id="2" competition_id="3" match_id="123" referee_id="4"]`

**Вывод:** Блок с тремя колонками, отображающими среднее количество голов, желтых карточек и угловых.

* * * * *

#### **3\. `expected_score`**

**Описание:** Отображает ожидаемый счет матча на основе статистики команд.

**Атрибуты:**

-   `match_id` *(целое число)*: ID матча.

**Пример Использования:**

html

Копіювати код

`[expected_score match_id="123"]`

**Вывод:** Отображение ожидаемого счета матча, подготовленное с использованием шаблона `match/match` в режиме `simple`.

* * * * *

#### **4\. `goals_probability`**

**Описание:** Отображает вероятность того, что общее количество голов в матче будет больше или меньше заданного значения.

**Атрибуты:**

-   `match_id` *(целое число)*: ID матча.
-   `home_club_id` *(целое число)*: ID домашней команды.
-   `away_club_id` *(целое число)*: ID гостевой команды.
-   `greater_than` *(число)*: Значение, с которым сравнивается общее количество голов (по умолчанию 2.5).
-   `size` *(строка)*: Размер отображения (`big` или другой).

**Пример Использования:**

html

Копіювати код

`[goals_probability match_id="123" greater_than="3.0" size="big"]`

**Вывод:** Графическое отображение вероятности (`Over 3.0` или `Under 3.0`) с использованием радиального прогресса.

* * * * *

#### **5\. `both_teams_to_score_probability`**

**Описание:** Отображает вероятность того, что обе команды забьют в матче (BTTS).

**Атрибуты:**

-   `match_id` *(целое число)*: ID матча.
-   `home_club_id` *(целое число)*: ID домашней команды.
-   `away_club_id` *(целое число)*: ID гостевой команды.
-   `size` *(строка)*: Размер отображения (`big` или другой).

**Пример Использования:**

html

Копіювати код

`[both_teams_to_score_probability match_id="123" size="big"]`

**Вывод:** Графическое отображение вероятности BTTS (`Yes` или `No`) с использованием радиального прогресса.

* * * * *

#### **6\. `custom_stat`**

**Описание:** Отображает специфическую статистику для команды (например, количество угловых, желтых карточек и т.д.).

**Атрибуты:**

-   `club_id` *(целое число)*: ID клуба.
-   `competition_id` *(целое число)*: ID соревнования.
-   `field` *(строка)*: Название статистического поля (например, `goals`, `corners`).
-   `place` *(строка)*: `h` для домашней команды или `a` для гостевой.

**Пример Использования:**

html

Копіювати код

`[custom_stat club_id="1" competition_id="3" field="goals" place="h"]`

**Вывод:** Отображение средней статистики (например, среднее количество голов) для указанной команды.

* * * * *

#### **7\. `custom_match_shortcode`**

**Описание:** Отображает список матчей, соответствующих определенным условиям предсказаний и количеству голов.

**Атрибуты:**

-   `prediction_score` *(целое число)*: Минимальный процент предсказания для отображения матча (по умолчанию 80).
-   `limit` *(целое число)*: Максимальное количество матчей для отображения (по умолчанию 20).
-   `goals_more` *(число)*: Значение для фильтрации матчей по вероятности большего количества голов.

**Пример Использования:**

html

Копіювати код

`[custom_match_shortcode prediction_score="75" limit="10" goals_more="3.0"]`

**Вывод:** Список матчей, где процент предсказания для домашней или гостевой команды превышает заданный уровень и вероятность превышения количества голов соответствует условию.

* * * * *

### **5\. Описание Основных Функций**

Класс `WizOdds_Prediction_Shortcodes` включает в себя множество функций, разделенных на категории для упрощения понимания и поддержки.

#### **Функции для Получения и Обработки Данных**

1.  **`get_prediction_data( $match_id )`**

    -   **Описание:** Получает данные предсказания из метаданных матча.
    -   **Параметры:**
        -   `$match_id` *(целое число)*: ID матча.
    -   **Возвращает:** Массив с процентами и сравнительными данными или `false`, если данные отсутствуют.
2.  **`get_team_stats( $club_id, $date_after, $competition_id )`**

    -   **Описание:** Получает статистику команды за указанный период.
    -   **Параметры:**
        -   `$club_id` *(целое число)*: ID клуба.
        -   `$date_after` *(строка)*: Дата после которой собираются данные.
        -   `$competition_id` *(целое число)*: ID соревнования.
    -   **Возвращает:** Массив статистики или `false`, если данные отсутствуют.
3.  **`get_referee_stats( $referee_id, $competition_id )`**

    -   **Описание:** Получает статистику рефери.
    -   **Параметры:**
        -   `$referee_id` *(целое число)*: ID рефери.
        -   `$competition_id` *(целое число)*: ID соревнования.
    -   **Возвращает:** Массив статистики или пустой массив.
4.  **`get_home_away_goals( $atts )`**

    -   **Описание:** Получает ожидаемые голы для домашней и гостевой команд.
    -   **Параметры:**
        -   `$atts` *(массив)*: Атрибуты шорткода.
    -   **Возвращает:** Массив с ожидаемыми голами или строку с сообщением об ошибке.
5.  **`get_custom_stat_shortcode( $club_id, $season_id, $field, $place )`**

    -   **Описание:** Получает и возвращает специфическую статистику для команды.
    -   **Параметры:**
        -   `$club_id` *(целое число)*: ID клуба.
        -   `$season_id` *(целое число)*: ID сезона.
        -   `$field` *(строка)*: Название поля статистики.
        -   `$place` *(строка)*: `h` для домашней или `a` для гостевой команды.
    -   **Возвращает:** Числовое значение статистики или сообщение об ошибке.

#### **Функции для Расчета Предсказаний**

1.  **`calculate_average( $value, $count )`**

    -   **Описание:** Рассчитывает среднее значение.
    -   **Параметры:**
        -   `$value` *(число)*: Общее значение.
        -   `$count` *(целое число)*: Количество элементов.
    -   **Возвращает:** Среднее значение или `0`, если `$count` равно нулю.
2.  **`calculate_club_coefficients( $comparison )`**

    -   **Описание:** Рассчитывает коэффициенты для домашней и гостевой команды на основе сравнительных данных.
    -   **Параметры:**
        -   `$comparison` *(массив)*: Сравнительные данные клуба.
    -   **Возвращает:** Массив с коэффициентами `[home_coefficient, away_coefficient]`.
3.  **`calculate_expected_goals( $home_gpm, $away_gpm, $home_gcpmm, $away_gcpmm, $home_coeff, $away_coeff )`**

    -   **Описание:** Рассчитывает ожидаемое количество голов для домашней и гостевой команды.
    -   **Параметры:**
        -   `$home_gpm` *(число)*: Среднее количество голов за матч домашней команды.
        -   `$away_gpm` *(число)*: Среднее количество голов за матч гостевой команды.
        -   `$home_gcpmm` *(число)*: Среднее количество пропущенных голов за матч домашней команды.
        -   `$away_gcpmm` *(число)*: Среднее количество пропущенных голов за матч гостевой команды.
        -   `$home_coeff` *(число)*: Коэффициент домашней команды.
        -   `$away_coeff` *(число)*: Коэффициент гостевой команды.
    -   **Возвращает:** Массив с ожидаемыми голами `[expected_home_goals, expected_away_goals]`.
4.  **`calculate_btts_probability_logic( $expected_home_goals, $expected_away_goals )`**

    -   **Описание:** Логика расчета вероятности BTTS.
    -   **Параметры:**
        -   `$expected_home_goals` *(число)*: Ожидаемые голы домашней команды.
        -   `$expected_away_goals` *(число)*: Ожидаемые голы гостевой команды.
    -   **Возвращает:** Вероятность BTTS *(число от 0 до 1)*.
5.  **`calculate_probability( $lambda, $greater_than )`**

    -   **Описание:** Рассчитывает вероятность, что общее количество голов превышает заданное значение на основе распределения Пуассона.
    -   **Параметры:**
        -   `$lambda` *(число)*: Среднее ожидаемое количество голов.
        -   `$greater_than` *(число)*: Значение, с которым сравнивается общее количество голов.
    -   **Возвращает:** Вероятность *(число от 0 до 1)*.
6.  **`poisson_probability( $lambda, $k )`**

    -   **Описание:** Рассчитывает вероятность события по распределению Пуассона.
    -   **Параметры:**
        -   `$lambda` *(число)*: Среднее ожидаемое количество событий.
        -   `$k` *(целое число)*: Точное количество событий.
    -   **Возвращает:** Вероятность *(число от 0 до 1)*.
7.  **`factorial( $n )`**

    -   **Описание:** Рассчитывает факториал числа.
    -   **Параметры:**
        -   `$n` *(целое число)*: Число для расчета факториала.
    -   **Возвращает:** Факториал числа.

#### **Функции для Генерации HTML**

1.  **`generate_prediction_html( $home_avg, $away_avg )`**

    -   **Описание:** Генерирует HTML для отображения процентных предсказаний.
    -   **Параметры:**
        -   `$home_avg` *(целое число)*: Процент для домашней команды.
        -   `$away_avg` *(целое число)*: Процент для гостевой команды.
    -   **Возвращает:** Строка с HTML-кодом.
2.  **`generate_probability_html( $probability, $odds_name, $prediction, $label, $size )`**

    -   **Описание:** Генерирует HTML для отображения вероятностей (например, Over/Under, BTTS).
    -   **Параметры:**
        -   `$probability` *(число)*: Вероятность события.
        -   `$odds_name` *(строка)*: Название коэффициента (например, "Goals Over/Under").
        -   `$prediction` *(строка)*: Предсказание (например, "Over 2.5").
        -   `$label` *(строка)*: Метка для отображения (например, "Over 2.5").
        -   `$size` *(строка)*: Размер отображения (`big` или другой).
    -   **Возвращает:** Строка с HTML-кодом.

#### **Функции для Отладки и Логирования**

1.  **`get_custom_stat_shortcode( $atts )`**
    -   **Описание:** Получает и возвращает специфическую статистику для команды, пригодную для использования в шорткоде.
    -   **Примечание:** Эта функция используется внутри шорткода `[custom_stat]` и не предназначена для непосредственного вызова.

* * * * *

### **6\. Примеры Использования**

#### **1\. Отображение Процентных Предсказаний Матча**

html

Копіювати код

`[custom_prediction match_id="123"]`

**Описание:** Показывает процентные предсказания для домашней и гостевой команды матча с ID 123.

* * * * *

#### **2\. Отображение Общей Статистики Матча**

html

Копіювати код

`[total_stats home_club_id="1" away_club_id="2" competition_id="3" match_id="123" referee_id="4"]`

**Описание:** Отображает среднее количество голов, желтых карточек и угловых для матча с ID 123 между командами с ID 1 и 2 в соревновании с ID 3, учитывая статистику рефери с ID 4.

* * * * *

#### **3\. Отображение Ожидаемого Счета Матча**

html

Копіювати код

`[expected_score match_id="123"]`

**Описание:** Показывает ожидаемый счет матча с ID 123.

* * * * *

#### **4\. Отображение Вероятности Больше или Меньше Заданного Количества Голов**

html

Копіювати код

`[goals_probability match_id="123" greater_than="3.0" size="big"]`

**Описание:** Показывает вероятность того, что общее количество голов в матче с ID 123 будет больше 3.0, используя большой размер отображения.

* * * * *

#### **5\. Отображение Вероятности BTTS (Both Teams To Score)**

html

Копіювати код

`[both_teams_to_score_probability match_id="123" size="big"]`

**Описание:** Показывает вероятность того, что обе команды забьют в матче с ID 123, используя большой размер отображения.

* * * * *

#### **6\. Отображение Специфической Статистики Команды**

html

Копіювати код

`[custom_stat club_id="1" competition_id="3" field="goals" place="h"]`

**Описание:** Показывает среднее количество голов, забитых домашней командой с ID 1 в соревновании с ID 3.

* * * * *

#### **7\. Отображение Списка Матчей с Определенными Условиями**

html

Копіювати код

`[custom_match_shortcode prediction_score="75" limit="10" goals_more="3.0"]`

**Описание:** Показывает список из 10 матчей, где процент предсказания для домашней или гостевой команды превышает 75% и вероятность превышения количества голов больше 3.0.

* * * * *

### **7\. Расширение и Настройка**

#### **1\. Добавление Новых Статистических Полей**

Чтобы добавить новые статистические поля, обновите массив `$valid_fields` в функции `custom_stat_shortcode`:

php

Копіювати код

`$valid_fields = array( 'cards_y', 'corners', 'goals_conceded', 'goals', 'wins', 'draws', 'losses', 'clean_sheets', 'new_field' );`

Не забудьте добавить соответствующую логику обработки в функции получения и отображения статистики.

#### **2\. Изменение Параметров Расчета Предсказаний**

Вы можете настроить весовые коэффициенты, преимущества дома и гостя, а также другие параметры расчета, изменив соответствующие значения в функциях `calculate_averages`, `calculate_expected_goals` и других расчетных функциях.

#### **3\. Добавление Кэширования**

Для улучшения производительности можно внедрить кэширование результатов расчетов с использованием Transients API WordPress:

php

Копіювати код

`$cache_key = 'prediction_data_' . $match_id;
$predictions = get_transient( $cache_key );

if ( false === $predictions ) {
    // Выполнить расчет и установить транзиент
    $predictions = $this->get_prediction_data( $match_id );
    set_transient( $cache_key, $predictions, HOUR_IN_SECONDS );
}`

#### **4\. Локализация и Перевод**

Используйте функции локализации WordPress (`__`, `_e`, `esc_html__`, и т.д.) для обеспечения перевода всех выводимых строк.

* * * * *

### **8\. Отладка и Логирование**

Для упрощения процесса отладки вы можете добавить логирование ошибок и важных событий. Используйте встроенный класс `WP_Error` или плагины для логирования.

**Пример:**

php

Копіювати код

`if ( empty( $home_stats ) || empty( $away_stats ) ) {
    error_log( "Недостаточно данных о командах для матча ID: {$match_id}" );
    return esc_html__( 'Недостаточно данных о голах и/или пропущенных голах для указанных команд.', 'wizodds' );
}`

* * * * *

### **9\. Безопасность**

-   **Экранирование Вывода:** Все данные, выводимые на страницу, экранируются с помощью функций `esc_html`, `esc_attr`, и `esc_text_field` для предотвращения XSS-атак.
-   **Валидация и Санитизация Входных Данных:** Все входящие параметры шорткодов проходят через функции `absint`, `floatval`, `sanitize_key`, и `sanitize_text_field` для обеспечения корректности и безопасности.
-   **Защита от Прямого Доступа:** В начале файла добавлена проверка `defined( 'ABSPATH' )` для предотвращения прямого доступа к файлу.

* * * * *

### **10\. Часто Задаваемые Вопросы (FAQ)**

**Вопрос:** Почему некоторые шорткоды не отображаются?

**Ответ:** Убедитесь, что плагин **AnWP Football Leagues Premium** активирован и настроен корректно, так как наши шорткоды зависят от данных, предоставляемых этим плагином.

* * * * *

**Вопрос:** Как добавить новый шорткод для другой статистики?

**Ответ:** Вам необходимо добавить соответствующую функцию в класс `WizOdds_Prediction_Shortcodes`, зарегистрировать новый шорткод с помощью `add_shortcode`, и обеспечить корректную обработку и вывод данных.

* * * * *

### **11\. Лицензия**

Этот код предоставляется под лицензией GPLv2 или более поздней, совместимой с лицензией WordPress.

* * * * *

**Заключение**
--------------

Данная документация должна помочь вам эффективно использовать и настраивать предоставленные шорткоды для отображения футбольной статистики и предсказаний на вашем сайте WordPress. При необходимости расширения функционала рекомендуется следовать принципам объектно-ориентированного программирования и поддерживать чистоту и безопасность кода.

Если у вас возникнут дополнительные вопросы или потребуется помощь, не стесняйтесь обращаться!
